<div id="card-form"></div>
<form name="datos">
  <input type="hidden" id="token" />
  <input type="hidden" id="errorCode" />
</form>
<script src="https://sis-t.redsys.es:25443/sis/NC/sandbox/redsysV3.js"></script>
<script>
  function merchantValidationEjemplo() {
    // Insertar validaciones propias
    alert("Esto son validaciones propias");
    return true;
  }

  // Listener de recepción de ID de operación
  window.addEventListener("message", function receiveMessage(event) {
    storeIdOper(event, "token", "errorCode", merchantValidationEjemplo);

    // Retrieve token and errorCode
    const token = document.getElementById("token").value;
    const errorCode = document.getElementById("errorCode").value;

    // Send a message with the payment status to React
    const paymentStatus = errorCode ? "failure" : "success";
    const message = {
      status: paymentStatus,
      token: token,
      errorCode: errorCode,
    };
    window.parent.postMessage(message, "*"); // Send message to React
    if (event.data === "payment-success") {
      parent.postMessage(
        { status: "success", token: document.getElementById("token").value },
        "*"
      );
    } else if (event.data === "payment-failed") {
      parent.postMessage(
        {
          status: "failure",
          errorCode: document.getElementById("errorCode").value,
        },
        "*"
      );
    }

    window.location.href = `/payment-done?status=${paymentStatus}&token=${token}&errorCode=${errorCode}`;
  });

  function pedido() {
    return "pedido" + Math.floor(Math.random() * 1000 + 1);
  }

  var insiteJSON = {
    id: "card-form",
    fuc: "999008881",
    terminal: "1",
    order: pedido(),
    estiloInsite: "twoRows",
  };

  getInSiteFormJSON(insiteJSON);
</script>
