<div id="card-form"></div>
<form name="datos">
  <input type="hidden" id="token" />
  <input type="hidden" id="errorCode" />
</form>
<script src="https://sis-t.redsys.es:25443/sis/NC/sandbox/redsysV3.js"></script>
<script>
  function merchantValidationEjemplo() {
    const cardNumber = document.getElementById("card-number")?.value;
    const expiryDate = document.getElementById("card-expiration")?.value;
    const cvv = document.getElementById("card-cvv")?.value;

    // Basic validations
    if (!cardNumber || !expiryDate || !cvv) {
      alert("Please fill in all the required fields.");
      return false;
    }

    if (cardNumber.length !== 16 || !/^\d{16}$/.test(cardNumber)) {
      alert("Card number must be 16 digits.");
      return false;
    }

    if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
      alert("Expiry date must be in MM/YY format.");
      return false;
    }

    const [month, year] = expiryDate.split("/").map(Number);
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear() % 100; // Last two digits of the current year
    const currentMonth = currentDate.getMonth() + 1;

    if (
      month < 1 ||
      month > 12 ||
      year < currentYear ||
      (year === currentYear && month < currentMonth)
    ) {
      alert("Expiry date is invalid or card has expired.");
      return false;
    }

    if (cvv.length < 3 || cvv.length > 4 || !/^\d{3,4}$/.test(cvv)) {
      alert("CVV must be 3 or 4 digits.");
      return false;
    }

    const errorCode = document.getElementById("errorCode")?.value;
    if (errorCode) {
      console.error("Error code:", errorCode);
      alert("An error occurred: " + errorCode);
      return false;
    }

    alert("Validation successful!");
    return true;
  }

  // Listener de recepción de ID de operación
  window.addEventListener("message", function receiveMessage(event) {
    storeIdOper(event, "token", "errorCode", merchantValidationEjemplo);

    // Retrieve token and errorCode
    const token = document.getElementById("token").value;
    const errorCode = document.getElementById("errorCode").value;

    // Send a message with the payment status to React
    const paymentStatus = errorCode ? "failure" : "success";
    const message = {
      status: paymentStatus,
      token: token,
      errorCode: errorCode,
    };
    window.parent.postMessage(message, "*");
    if (event.data === "payment-success") {
      parent.postMessage(
        { status: "success", token: document.getElementById("token").value },
        "*"
      );
    } else if (event.data === "payment-failed") {
      parent.postMessage(
        {
          status: "failure",
          errorCode: document.getElementById("errorCode").value,
        },
        "*"
      );
    }

    //window.location.href = `/payment-done?status=${paymentStatus}&token=${token}&errorCode=${errorCode}`;
    window.parent.postMessage(
      window.location.href,
      `/payment-done?status=${paymentStatus}&token=${token}&errorCode=${errorCode}`
    );
  });

  function pedido() {
    return "pedido" + Math.floor(Math.random() * 1000 + 1);
  }

  var insiteJSON = {
    id: "card-form",
    fuc: "999008881",
    terminal: "1",
    order: pedido(),
    estiloInsite: "twoRows",
  };

  getInSiteFormJSON(insiteJSON);
</script>
